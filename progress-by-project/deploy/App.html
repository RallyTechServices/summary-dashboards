<!DOCTYPE html>
<html>
<head>
    <title>progress-by-project</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("RallyFunctions",function(){var self;return{config:{ctx:{}},constructor:function(config){return self=this,this.initConfig(config),this},_wsapiQuery:function(config,callback){var storeConfig={autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}};_.isUndefined(config.context)||(storeConfig.context=config.context),Ext.create("Rally.data.WsapiDataStore",storeConfig)},createFilter:function(releaseName,iterationName){var filter=null;if(_.isNull(releaseName)||(filter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",operator:"=",value:releaseName})),!_.isNull(iterationName)){var ifilter=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.Name",operator:"=",value:iterationName});filter=_.isNull(filter)?ifilter:filter.and(ifilter)}return filter},createFeatureFilter:function(releaseName){var filter=null;return _.isNull(releaseName)||(filter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",operator:"=",value:releaseName})),filter},subscribe:function(app){app.subscribe(app,"timeboxReleaseChanged",app._timeboxChanged,app),app.subscribe(app,"timeboxIterationChanged",app._timeboxChanged,app)}}});
                Ext.define("ProjectStories",function(){var self;return{config:{ctx:{},filter:null,featureFilter:null},constructor:function(config){return self=this,this.initConfig(config),this},readProjectWorkItems:function(callback){var fns=[self.readStates,self.readProjects,self.readStories];null!==self.featureFilter&&(fns=[self.readStates,self.readProjects,self.readFeatures]),Deft.Chain.pipeline(fns,self).then({success:function(workItems){callback(null,workItems,self.projects,self.scheduleStates)},failure:function(error){console.log("Error:",error)}})},readStates:function(){var that=this,deferred=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"UserStory",success:function(model){model.getField("ScheduleState").getAllowedValueStore().load({callback:function(records,operation,success){self.scheduleStates=_.map(records,function(r){return r.get("StringValue")}),deferred.resolve(self.scheduleStates)}})}}),deferred.promise},readProjects:function(states){var deferred=Ext.create("Deft.Deferred"),me=this;return self._loadAStoreWithAPromise("Project",["_ref","Parent","Children"],[{property:"ObjectID",operator:"=",value:self.ctx.getProject().ObjectID}]).then({scope:me,success:function(projects){_.first(projects).getCollection("Children").load({fetch:["ObjectID","Name","_ref","Parent","State"],callback:function(records,operation,success){self.projects=_.filter(records,function(r){return"Closed"!==r.get("State")}),deferred.resolve(self.projects)}})}}),deferred.promise},readStories:function(projects){var me=this,promises=_.map(projects,function(project){var deferred=Ext.create("Deft.Deferred");return self._loadAStoreWithAPromise("HierarchicalRequirement",["ObjectID","ScheduleState","PlanEstimate","Project"],[self.filter],{project:project.get("_ref"),projectScopeUp:!1,projectScopeDown:!0}).then({scope:me,success:function(stories){deferred.resolve(stories)}}),deferred.promise});return Deft.Promise.all(promises)},readFeatures:function(projects){var me=this,readFeatureType=function(){var deferred=Ext.create("Deft.Deferred");return self._loadAStoreWithAPromise("TypeDefinition",["TypePath"],[{property:"Ordinal",operator:"=",value:0}]).then({scope:me,success:function(types){deferred.resolve(_.first(types).get("TypePath"))}}),deferred.promise},readFeatures=function(type){var promises=_.map(projects,function(project){var deferred=Ext.create("Deft.Deferred");return self._loadAStoreWithAPromise(type,["FormattedID","Name","ObjectID","LeafStoryCount","LeafStoryPlanEstimateTotal","PreliminaryEstimate","AcceptedLeafStoryCount","AcceptedLeafStoryPlanEstimateTotal","PercentDoneByStoryCount","c_ValueMetricKPI","Rank"],[self.featureFilter],{project:project.get("_ref"),projectScopeUp:!1,projectScopeDown:!0},[{property:"DragAndDropRank",direction:"ASC"}]).then({scope:me,success:function(stories){deferred.resolve(stories)}}),deferred.promise});return Deft.Promise.all(promises)},deferred=Ext.create("Deft.Deferred");return Deft.Chain.pipeline([readFeatureType,readFeatures],self).then({success:function(results){deferred.resolve(results)}}),deferred.promise},readPreferenceValues:function(keys){var me=this,promises=_.map(keys,function(key){var deferred=Ext.create("Deft.Deferred");return self._loadAStoreWithAPromise("Preference",["Name","Value"],[{property:"Name",operator:"=",value:key}]).then({scope:me,success:function(values){deferred.resolve(values)},failure:function(error){deferred.resolve("")}}),deferred.promise});return Deft.Promise.all(promises)},_loadAStoreWithAPromise:function(model_name,model_fields,filters,ctx,order){var deferred=Ext.create("Deft.Deferred"),me=this,config={model:model_name,fetch:model_fields,filters:filters,limit:"Infinity"};return _.isUndefined(ctx)||_.isNull(ctx)||(config.context=ctx),_.isUndefined(order)||_.isNull(order)||(config.order=order),Ext.create("Rally.data.wsapi.Store",config).load({callback:function(records,operation,successful){successful?deferred.resolve(records):deferred.reject("Problem loading: "+operation.error.errors.join(". "))}}),deferred.promise}}});
                Ext.define("timebox-selector",{extend:"Ext.Container",componentCls:"app",alias:"widget.timebox-selector",cls:"timebox-selector",layout:"hbox",width:"100%",mixins:["Rally.Messageable"],constructor:function(){this.stateId=Rally.environment.getContext().getScopedStateId("timebox-filter"),this.callParent(arguments)},initComponent:function(){this.callParent(arguments),this._createReleaseCombo(),this.addEvents("releasechange","iterationchange"),this.subscribe(this,"requestTimebox",this._requestTimebox,this)},_createReleaseCombo:function(){this._releaseCombo=this.add({xtype:"rallyreleasecombobox",fieldLabel:"Program Increment",hideLabel:!1,labelPad:5,labelSeparator:":",labelWidth:130,width:280,labelAlign:"right",stateful:!1,stateId:"releasecombo",padding:5,context:Rally.environment.getContext(),showArrows:!1,growToLongestValue:!0,defaultToCurrentTimebox:!0,listeners:{change:function(t,newVal,oldVal,eOpts){var release=t.getRecord();this.fireEvent("releasechange",release),console.log("Publishing Release:",release),this.publish("timeboxReleaseChanged",release),this._updateIterationCombo(release)},scope:this}})},_updateIterationCombo:function(release){this.remove("globaliterationpicker");var endFilter=Ext.create("Rally.data.wsapi.Filter",{property:"EndDate",operator:"<=",value:Rally.util.DateTime.toIsoString(release.get("ReleaseDate"))}),startFilter=Ext.create("Rally.data.wsapi.Filter",{property:"StartDate",operator:">=",value:Rally.util.DateTime.toIsoString(release.get("ReleaseStartDate"))}),filters=endFilter.and(startFilter);this._iterationCombo=this.add({xtype:"rallyiterationcombobox",itemId:"globaliterationpicker",fieldLabel:"Sprint/Iteration",hideLabel:!1,labelPad:5,labelSeparator:":",labelWidth:100,labelAlign:"right",stateful:!1,padding:5,context:Rally.environment.getContext(),showArrows:!1,growToLongestValue:!0,stateId:"iterationcombo",allowBlank:!0,allowClear:!0,allowNoEntry:!0,noEntryText:"PI Scope",emptyText:"PI Scope",noEntryValue:null,defaultToCurrentTimebox:!1,defaultSelectPosition:"first",storeConfig:{remoteFilter:!0,filters:filters},listeners:{change:function(t,newVal,oldVal,eOpts){var iteration=t.getRecord();this.fireEvent("iterationchange",iteration),this.publish("timeboxIterationChanged",iteration)},scope:this}})},_requestTimebox:function(source){console.log("Got request timebox message",source);var release=this.getReleaseRecord();console.log("release",release),release&&this.publish("timeboxReleaseChanged",release);var iteration=this.getIterationRecord();console.log("iteration",iteration),iteration&&this.publish("timeboxIterationChanged",iteration)},getReleaseRecord:function(){return this._releaseCombo?this._releaseCombo.getRecord()||null:null},getIterationRecord:function(){return this._iterationCombo?this._iterationCombo.getRecord()||null:null}});
                Ext.override(Rally.ui.chart.Chart,{onRender:function(){this.callParent(arguments),this._unmask()}}),Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"settings_box"},{xtype:"container",itemId:"selector_box"}],config:{defaultSettings:{showScopeSelector:!1}},launch:function(){this.isExternal()?this.showSettings(this.config):this.onSettingsUpdate(this.getSettings())},_launch:function(settings){var that=this;that.rallyFunctions=Ext.create("RallyFunctions"),console.log("Settings:",settings),settings.showScopeSelector===!0||"true"===settings.showScopeSelector?this.down("#selector_box").add({xtype:"timebox-selector",context:this.getContext(),listeners:{releasechange:function(release){this._changeRelease(release)},iterationchange:function(iteration){this._changeIteration(iteration)},scope:this}}):(this.subscribe(this,"timeboxReleaseChanged",this._changeRelease,this),this.subscribe(this,"timeboxIterationChanged",this._changeIteration,this),this.publish("requestTimebox",this)),that.run(release,iteration)},_changeRelease:function(release){this.run(release.get("Name"),null)},_changeIteration:function(iteration){this.run(null,iteration.get("Name"),null)},run:function(releaseName,iterationName){var that=this;console.log("run progress-by-project:",releaseName,iterationName),this.setLoading("Loading Stories in Project...");var pr=Ext.create("ProjectStories",{ctx:that.getContext(),filter:that.rallyFunctions.createFilter(releaseName,iterationName)});pr.readProjectWorkItems(function(error,stories,projects,states){that.prepareChartData(stories,projects,states,function(error,categories,series){that.createChart(categories,series)})})},_timeboxChanged:function(timebox){var that=this;console.log("Progress-By-Project:_timeboxChanged received"),"release"===timebox.get("_type")?that.run(timebox.get("Name"),null):that.run(null,timebox.get("Name"))},getTimeboxScope:function(){var timeboxScope=this.getContext().getTimeboxScope();return timeboxScope?{type:timeboxScope.getType(),name:timeboxScope.getRecord().get("Name")}:null},onTimeboxScopeChange:function(newTimeboxScope){this.callParent(arguments),newTimeboxScope&&"iteration"===newTimeboxScope.getType()?this.run(null,newTimeboxScope.getRecord().get("Name")):newTimeboxScope&&"release"===newTimeboxScope.getType()&&this.run(newTimeboxScope.getRecord().get("Name"),null)},prepareChartData:function(stories,projects,states,callback){var that=this,projectKeys=_.map(projects,function(project){return _.last(project.get("Name").split(">"))}),pointsValue=function(value){return _.isUndefined(value)||_.isNull(value)?0:value},summarize=function(workItems,states){var total=_.reduce(workItems,function(memo,workItem){return memo+pointsValue(workItem.get("PlanEstimate"))},0),stateTotal=_.reduce(workItems,function(memo,workItem){return memo+(_.indexOf(states,workItem.get("ScheduleState"))>-1?pointsValue(workItem.get("PlanEstimate")):0)},0),p=total>0?100*(stateTotal/total):0;return Math.round(p)},summary=that.createSummaryRecord(),seriesData=_.map(_.keys(summary),function(summaryKey){return{name:summaryKey,data:_.map(projectKeys,function(projectKey,index){return summarize(stories[index],summary[summaryKey])})}});callback(null,projectKeys,seriesData)},createChart:function(categories,seriesData,callback){var that=this;that.setLoading(!1),_.isUndefined(that.chart)||that.remove(that.chart),that.chart=Ext.create("Rally.technicalservices.progressChart",{itemId:"rally-chart",chartData:{series:seriesData,categories:categories},title:"Progress By Project"}),that.add(that.chart);var chart=this.down("#rally-chart"),p=Ext.get(chart.id),elems=p.query("div.x-mask");_.each(elems,function(e){Ext.isIE9?e.removeNode():e.remove()}),elems=p.query("div.x-mask-msg"),_.each(elems,function(e){Ext.isIE9?e.removeNode():e.remove()})},createSummaryRecord:function(){var that=this,summary={Backlog:["Defined"],"In-Progress":["In-Progress"],Complete:["Completed"],Accepted:["Accepted"]},first=_.first(that.scheduleStates),last=_.last(that.scheduleStates);return-1===_.indexOf(summary[_.first(_.keys(summary))],first)&&summary[_.first(_.keys(summary))].push(_.first(that.scheduleStates)),-1===_.indexOf(summary[_.last(_.keys(summary))],last)&&summary[_.last(_.keys(summary))].push(_.last(that.scheduleStates)),summary},isExternal:function(){return this.getAppId()===void 0},showSettings:function(options){return this._appSettings=Ext.create("Rally.app.AppSettings",Ext.apply({fields:this.getSettingsFields(),settings:this.getSettings(),defaultSettings:this.getDefaultSettings(),context:this.getContext(),settingsScope:this.settingsScope,autoScroll:!0},options)),this._appSettings.on("cancel",this._hideSettings,this),this._appSettings.on("save",this._onSettingsSaved,this),this.isExternal()?void 0===this.down("#settings_box").getComponent(this._appSettings.id)&&this.down("#settings_box").add(this._appSettings):(this.hide(),this.up().add(this._appSettings)),this._appSettings},_onSettingsSaved:function(settings){Ext.apply(this.settings,settings),this._hideSettings(),this.onSettingsUpdate(settings)},onSettingsUpdate:function(settings){console.log("onSettingsUpdate",settings),Ext.apply(this,settings),this._launch(settings)},getSettingsFields:function(){var me=this;return[{name:"showScopeSelector",xtype:"rallycheckboxfield",boxLabelAlign:"after",fieldLabel:"",margin:"0 0 25 200",boxLabel:'Show Scope Selector<br/><span style="color:#999999;"><i>Tick to use this to broadcast settings.</i></span>'}]}});
                Ext.define("Rally.technicalservices.progressChart",{extend:"Rally.ui.chart.Chart",alias:"widget.progresschart",itemId:"rally-chart",chartData:{},loadMask:!1,chartColors:[],chartConfig:{colors:["#E0E0E0","#00a9e0","#fad200","#8dc63f"],chart:{type:"bar"},title:{text:"Progress by Project"},xAxis:{tickInterval:1,title:{text:""}},yAxis:[{min:0,max:100,title:{text:"% of Scheduled Stories by State"}}],plotOptions:{series:{dataLabels:{enabled:!0,align:"center",formatter:function(){return 0!==this.percentage?Math.round(this.percentage)+" %":""},color:"#FFFFFF"},stacking:"percent"}}},constructor:function(config){this.callParent(arguments),config.title&&(this.chartConfig.title=config.title)}});

            Rally.launchApp('CustomApp', {
                name:"progress-by-project",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
