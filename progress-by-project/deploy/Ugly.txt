<!DOCTYPE html>
<html>
<head>
    <title>Progress by Project</title>
    <!--  (c) 2017 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Sun Jul 23 2017 14:58:00 GMT-0700 (PDT) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Sun Jul 23 2017 14:58:00 GMT-0700 (PDT)";
        var STORY    = "...US1237";
        var BUILDER  = "marjo60";
        var CHECKSUM = 15989256406;
    </script>
    
    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns) 
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>
    -->
    
    
    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define("Rally.technicalservices.Logger",{constructor:function(a){Ext.apply(this,a)},log:function(a){if(!Ext.isIE9m){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,c)}}}),Ext.define("CArABU.timeboxselector",{extend:"Ext.Container",componentCls:"app",alias:"widget.tstimeboxselector",cls:"timebox-selector",layout:"hbox",configs:{iterationNoEntryText:"PI Scope"},mixins:["Rally.Messageable"],constructor:function(){this.stateId=Rally.environment.getContext().getScopedStateId("timebox-filter"),this.callParent(arguments)},initComponent:function(){this.callParent(arguments),this._createReleaseCombo(),this.addEvents("releasechange","iterationchange"),this.subscribe(this,"timeboxReleaseChanged",this._updateIterationCombo,this),this.subscribe(this,"requestTimebox",this._requestTimebox,this)},_createReleaseCombo:function(){var a=Rally.getApp().getContext().getTimeboxScope();if(a&&"release"===a.getType()){var b=a.getRecord();return console.log("Page has release: ",b),this.fireEvent("releasechange",b),this.publish("timeboxReleaseChanged",b),void this._updateIterationCombo(b)}this._releaseCombo=this.add({xtype:"rallyreleasecombobox",fieldLabel:"Program Increment",hideLabel:!1,labelPad:5,labelSeparator:":",labelWidth:130,width:280,labelAlign:"right",stateful:!1,stateId:"releasecombo",padding:5,context:Rally.environment.getContext(),showArrows:!1,growToLongestValue:!0,defaultToCurrentTimebox:!0,listeners:{change:function(a,b,c,d){var e=a.getRecord();this.fireEvent("releasechange",e),this.publish("timeboxReleaseChanged",e)},scope:this}})},_updateIterationCombo:function(a){console.log("Update iteration combobox"),this.remove("globaliterationpicker"),this.fireEvent("iterationchange",null),this.publish("timeboxIterationChanged",null);var b=Ext.create("Rally.data.wsapi.Filter",{property:"EndDate",operator:"<=",value:Rally.util.DateTime.toIsoString(a.get("ReleaseDate"))}),c=Ext.create("Rally.data.wsapi.Filter",{property:"StartDate",operator:">=",value:Rally.util.DateTime.toIsoString(a.get("ReleaseStartDate"))}),d=b.and(c);this._iterationCombo=this.add({xtype:"rallyiterationcombobox",itemId:"globaliterationpicker",fieldLabel:"Iteration",hideLabel:!1,labelPad:5,labelSeparator:":",labelWidth:100,labelAlign:"right",stateful:!1,padding:5,context:Rally.environment.getContext(),showArrows:!1,growToLongestValue:!0,stateId:"iterationcombo",allowBlank:!0,allowClear:!1,allowNoEntry:!0,noEntryText:this.iterationNoEntryText,emptyText:this.iterationNoEntryText,noEntryValue:null,defaultToCurrentTimebox:!1,defaultSelectPosition:"first",storeConfig:{remoteFilter:!0,filters:d},listeners:{change:function(a,b,c,d){var e=a.getRecord();this.fireEvent("iterationchange",e),this.publish("timeboxIterationChanged",e)},scope:this}})},_requestTimebox:function(a){var b=this.getReleaseRecord();b&&this.publish("timeboxReleaseChanged",b);var c=this.getIterationRecord();c&&this.publish("timeboxIterationChanged",c)},getReleaseRecord:function(){return this._releaseCombo?this._releaseCombo.getRecord()||null:null},getIterationRecord:function(){return this._iterationCombo?this._iterationCombo.getRecord()||null:null}}),Ext.define("CArABU.TSUtils",{singleton:!0,getPortfolioItemTypes:function(){var a={fetch:["Name","ElementName","TypePath"],model:"TypeDefinition",filters:[{property:"Parent.Name",operator:"=",value:"Portfolio Item"},{property:"Creatable",operator:"=",value:"true"}]};return CArABU.TSUtils.loadWsapiRecords(a)},getScheduleStates:function(){var a=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"UserStory",success:function(b){b.getField("ScheduleState").getAllowedValueStore().load({callback:function(b,c,d){var e=Ext.Array.map(b,function(a){return a.get("StringValue")});a.resolve(e)}})}}),a.promise},loadWsapiRecords:function(a,b){var c=Ext.create("Deft.Deferred"),d={model:"Defect",fetch:["ObjectID"]},e=Ext.Object.merge(d,a),f="Rally.data.wsapi.Store";return e.models&&(f="Rally.data.wsapi.artifact.Store"),Ext.create(f,e).load({callback:function(a,d,e){e?b?c.resolve(d):c.resolve(a):c.reject("Problem loading: "+d.error.errors.join(". "))}}),c.promise},createFilter:function(a,b,c){var d=Rally.data.wsapi.Filter.and([{property:"DirectChildrenCount",value:0}]);if(!_.isNull(a)){var e=[{property:"Release.Name",value:a}];c&&(e=[{property:c+".Release.Name",value:a}]),d=d.and(Rally.data.wsapi.Filter.or(e))}if(!_.isNull(b)){var f=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.Name",operator:"=",value:b});d=_.isNull(d)?f:d.and(f)}return d}}),Ext.define("TSProgressByProject",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,items:[{xtype:"container",itemId:"settings_box"},{xtype:"container",itemId:"selector_box",layout:"hbox"}],config:{defaultSettings:{showScopeSelector:!0,filterFieldName:"Commitment for Release",iterationNoEntryText:"PI Scope",considerVelocity:!0,groupByFeatureInsteadOfProject:!1}},chart:null,launch:function(){this.considerVelocity=this.getSetting("considerVelocity"),this.groupByFeatureInsteadOfProject=this.getSetting("groupByFeatureInsteadOfProject")||!1,this.groupByFeatureInsteadOfProject&&(this.considerVelocity=!1,this.updateSettingsValues({considerVelocity:!1})),this.setLoading("Loading..."),Deft.Chain.sequence([CArABU.TSUtils.getPortfolioItemTypes,CArABU.TSUtils.getScheduleStates],this).then({scope:this,success:function(a){this.states=a[1],this.types=a[0],this.logger.log("Found states/types",this.states,this.types);var b=this.getSettings();this.bottom_type_path=this.types[0].get("TypePath"),this.show_scope_selector=!1,(b.showScopeSelector===!0||"true"===b.showScopeSelector)&&(this.show_scope_selector=!0),this._prepareSelectors()}})},_prepareSelectors:function(){if(this.show_scope_selector?this.down("#selector_box").add({xtype:"tstimeboxselector",context:this.getContext(),iterationNoEntryText:this.getSetting("iterationNoEntryText"),listeners:{releasechange:function(a){this._changeRelease(a)},iterationchange:function(a){this._changeIteration(a)},scope:this}}):(this.subscribe(this,"timeboxReleaseChanged",this._changeRelease,this),this.subscribe(this,"timeboxIterationChanged",this._changeIteration,this),this.publish("requestTimebox",this)),this.getSetting("filterField")){var a=this.getSetting("filterFieldName")||this.getSetting("filterField"),b=Ext.String.format("Restrict {0} to:",a);this.fieldValuePicker=this.down("#selector_box").add({xtype:"rallyfieldvaluecombobox",fieldLabel:b,labelWidth:225,labelAlign:"right",margin:"7 0 0 25",minWidth:300,value:["zz"],allowClear:!1,setUseNullForNoEntryValue:!0,model:this.bottom_type_path,field:this.getSetting("filterField"),multiSelect:!0,listeners:{scope:this,blur:function(){this._findItemsAndMakeChart(this.release&&this.release.get("Name"),this.iteration&&this.iteration.get("Name"))}}})}},_changeRelease:function(a){this.logger.log("Change release",a),this.release=a,this.iteration=null,Ext.isEmpty(this.release)||this._findItemsAndMakeChart(a.get("Name"),null)},_changeIteration:function(a){return this.logger.log("Change Iteration",a),this.iteration=a,Ext.isEmpty(a)?void(Ext.isEmpty(this.release)||this._findItemsAndMakeChart(this.release.get("Name"),null)):void(Ext.isEmpty(this.release)?this._findItemsAndMakeChart(null,a.get("Name")):this._findItemsAndMakeChart(this.release.get("Name"),this.iteration.get("Name")))},_defineFilter:function(a,b){this.logger.log("Making filter for ",a,b);var c=this._getFeatureFieldName(),d=this.fieldValuePicker&&this.fieldValuePicker.getValue()||[],e=this.getSetting("filterField"),f=CArABU.TSUtils.createFilter(a,b,c);if(e&&d&&d.length>0){var g=Ext.Array.map(d,function(a){return"None"==a&&(a=""),{property:c+"."+e,value:a}}),h=Rally.data.wsapi.Filter.or(g);f=f.and(h)}return this.logger.log("filter:",f),f},_findItemsAndMakeChart:function(a,b){var c=Ext.create("Deft.Deferred"),d=this._defineFilter(a,b),e=[function(){return this._getBuckets(a,b)},function(a){return this._getStoriesByBucket(d,a)},function(a){var b=a[0],c=a[1];return this.groupByFeatureInsteadOfProject?[b,c,{}]:this._getVelocitiesByProject(b,c)}];return Deft.Chain.pipeline(e,this).then({success:function(a){var b=a[0],c=a[1],d=a[2],e=this.prepareChartData(b,c,d);this.createChart(e)},failure:function(a){c.reject(a)},scope:this}),c.promise},_getBuckets:function(a){return this.groupByFeatureInsteadOfProject?this._getFeatures(a):this._getProjects()},_getFeatures:function(a){var b={model:this.bottom_type_path||"PortfolioItem/Feature",fetch:["ObjectID","Name","FormattedID"],filters:[{property:"Release.Name",value:a}]};return CArABU.TSUtils.loadWsapiRecords(b)},_getProjects:function(){var a=Ext.create("Deft.Deferred"),b=this.getContext().getProject().ObjectID;return Rally.data.ModelFactory.getModel({type:"Project",success:function(c){c.load(b,{fetch:["_ref","Parent","Children"],callback:function(b,c){c.wasSuccessful()||a.reject(c),0===b.get("Children").Count?a.resolve([b]):b.getCollection("Children").load({fetch:["ObjectID","Name","_ref","Parent","State"],callback:function(b,c,d){var e=Ext.Array.filter(b,function(a){return"Closed"!==a.get("State")});a.resolve(e)}})}})}}),a.promise},_getStoriesByBucket:function(a,b){var c=Ext.create("Deft.Deferred");this.logger.log("_getStoriesByBucket",a,b);var d=Ext.Array.map(b,function(c){var d={model:"HierarchicalRequirement",fetch:["ObjectID","ScheduleState","PlanEstimate","Project","Name","FormattedID"],filters:a,config:null,limit:1/0,pageSize:2e3};return"project"==b[0].get("_type")?d.context={project:c.get("_ref"),projectScopeUp:!1,projectScopeDown:!0}:d.filters=a.and({property:this._getFeatureFieldName()+".FormattedID",value:c.get("FormattedID")}),function(){return CArABU.TSUtils.loadWsapiRecords(d)}},this);return Deft.Chain.sequence(d,this).then({success:function(a){var d={};Ext.Array.each(b,function(b,c){var e=b.get(this._getIdField());d[e]=a[c]||[]},this),c.resolve([b,d])},failure:function(a){c.reject(a)},scope:this}),c.promise},_getIdField:function(){return this.groupByFeatureInsteadOfProject?"FormattedID":"_refObjectName"},_getVelocitiesByProject:function(a,b){var c=this,d=Ext.create("Deft.Deferred"),e=[];return Ext.Array.each(a,function(a){e.push(function(){return c._getVelocityForProject(a)})}),Deft.Chain.sequence(e,this).then({success:function(c){var e={};Ext.Array.each(c,function(b,c){var d=a[c].get("Name");e[d]=b}),d.resolve([a,b,e])},failure:function(a){d.reject(a)}}),d.promise},_getVelocityForProject:function(a){var b=Ext.create("Deft.Deferred");return this._getLastSixIterations(a).then({scope:this,success:function(c){var d=[];if(Ext.Array.each(c,function(a){d.push({property:"Iteration.Name",value:a.get("Name")})}),0===c.length)return void b.resolve(0);var e=Rally.data.wsapi.Filter.or(d);e=e.and(Ext.create("Rally.data.wsapi.Filter",{property:"AcceptedDate",operator:"!=",value:null}));var f={models:["HierarchicalRequirement"],fetch:["PlanEstimate","FormattedID","ScheduleState","Name"],filters:e,context:{project:{_ref:a.get("_ref")},projectScopeDown:!0,projectScopeUp:!1},limit:1/0,pageSize:2e3};CArABU.TSUtils.loadWsapiRecords(f).then({success:function(a){var d=0;Ext.Array.each(a,function(a){var b=a.get("PlanEstimate")||0;d+=b});d/c.length;b.resolve(d)},failure:function(a){b.reject(a)}})},failure:function(a){b.reject(a)}}),b.promise},_getLastSixIterations:function(a){var b=Rally.util.DateTime.toIsoString(new Date),c={limit:6,pageSize:6,model:"Iteration",fetch:["Name"],sorters:{property:"EndDate",direction:"DESC"},filters:[{property:"EndDate",operator:"<",value:b},{property:"Project.ObjectID",value:a.get("ObjectID")}]};return CArABU.TSUtils.loadWsapiRecords(c)},_timeboxChanged:function(a){this.logger.log("_timeboxChanged",a),"release"===a.get("_type")?this._findItemsAndMakeChart(a.get("Name"),null):this._findItemsAndMakeChart(null,a.get("Name"))},getTimeboxScope:function(){var a=this.getContext().getTimeboxScope();return a?{type:a.getType(),name:a.getRecord().get("Name")}:null},onTimeboxScopeChange:function(a){this.callParent(arguments),a&&"iteration"===a.getType()?this._findItemsAndMakeChart(null,a.getRecord().get("Name")):a&&"release"===a.getType()&&(this.release=a.getRecord(),this.publish("timeboxReleaseChanged",this.release),this._findItemsAndMakeChart(this.release.getName(),null))},getPointsByState:function(a,b,c){var d=_.reduce(a,function(a,b){var c=b.get("PlanEstimate")||0;return a+c},0),e=d;c>=d&&this.considerVelocity&&!this.iteration&&(e=c);var f=_.reduce(a,function(a,c){var d=c.get("PlanEstimate")||0;return a+(_.indexOf(b,c.get("ScheduleState"))>-1?d:0)},0),g=e>0?f/e*100:0,h={p:g,total:d};return h},prepareChartData:function(a,b,c){var d=(this.states,this),e=Ext.Array.map(a,function(a){return a.get(this._getIdField())},this),f=this.createSummaryRecord(),g=_.map(_.keys(f),function(a){return{name:a,data:_.map(e,function(e,g){return{_total:d.getPointsByState(b[e],f[a],c[e]).total,y:d.getPointsByState(b[e],f[a],c[e]).p,_velocity:c[e],events:{click:function(){d._showDetailsDialog(e,b[e],a)}}}})}});return{series:g,categories:e}},formatter:function(a){var b=this.series.name+": "+Math.round(this.y)+"%<br/>Total: "+Math.round(this.point._total)+" points";return this.considerVelocity&&(b=b+"<br/>Velocity: "+Math.round(this.point._velocity)+" points"),b},createChart:function(a){this.setLoading(!1);var b=this._getPlotLineForCurrentPoint(this.release,this.iteration),c="% of Scheduled Stories by State by Points";this.considerVelocity&&!this.iteration&&(c="Scheduled Stories by State by Points (as a % of 6 Sprint Velocity Total)");var d="Progress by Project";this.groupByFeatureInsteadOfProject&&(d="Progress by "+this._getFeatureFieldName());var e={min:0,max:100,title:{text:c}};Ext.isEmpty(b)||(e.plotLines=[b]),this.chart=Ext.create("Rally.ui.chart.Chart",{itemId:"rally-chart",chartColors:["#ee6c19","#FAD200","#3F86C9","#8DC63F","#888","#222"],chartData:a,chartConfig:{colors:["#ee6c19","#FAD200","#3F86C9","#8DC63F","#888","#222"],chart:{type:"bar"},title:{text:d},xAxis:{tickInterval:1,title:{text:""}},yAxis:[e],legend:{reversed:!0},plotOptions:{series:{dataLabels:{enabled:!0,align:"center",formatter:function(){if(0===this.y)return"";var a=Math.round(this.y);return this.point._total>this.point._velocity?"<span class='icon-warning'></span>"+a+" %":a+" %"},useHTML:!0,color:"#FFFFFF"},stacking:"normal"}},tooltip:{enabled:!0,formatter:this.formatter}}}),this.down("#rally-chart")&&this.down("#rally-chart").destroy(),this.add(this.chart)},createSummaryRecord:function(){var a={};Ext.Array.each(this.states,function(b){a[b]=[b]});var b=_.first(this.states),c=_.last(this.states);return-1===_.indexOf(a[_.first(_.keys(a))],b)&&a[_.first(_.keys(a))].push(_.first(this.states)),-1===_.indexOf(a[_.last(_.keys(a))],c)&&a[_.last(_.keys(a))].push(_.last(this.states)),a},_getPlotLineForCurrentPoint:function(a,b){if(Ext.isEmpty(b)&&Ext.isEmpty(a))return null;var c=null,d=null,e=null;Ext.isEmpty(a)||(c=a.get("ReleaseStartDate"),d=a.get("ReleaseDate"),e="Release"),Ext.isEmpty(b)||Ext.isEmpty(b.get("StartDate"))||(c=b.get("StartDate"),d=b.get("EndDate"),e="Iteration");var f=new Date,g=Rally.util.DateTime.getDifference(d,c,"day"),h=Rally.util.DateTime.getDifference(f,c,"day"),i=h/g;if(0>i||i>1)return null;var j={value:100*i,color:"green",dashStyle:"shortdash",width:2,label:{text:"today"},zIndex:5};return j},_getFeatureFieldName:function(){var a=this.bottom_type_path||"Feature";return a=a.replace(/^.*\//,"")},getSettingsFields:function(){return[{name:"filterFieldName",xtype:"rallytextfield",hidden:!0},{name:"filterField",xtype:"rallyfieldcombobox",fieldLabel:"Filter Field",labelWidth:80,labelAlign:"left",width:250,margin:25,autoExpand:!1,alwaysExpanded:!1,model:this.bottom_type_path,_isNotHidden:function(a){if(a.hidden)return!1;var b=a.attributeDefinition;return Ext.isEmpty(b)?!1:b.Constrained&&("STRING"==b.AttributeType||"RATING"==b.AttributeType)},listeners:{change:function(a){var b=a.getRecord();b&&(name=b.get("name"));var c=Ext.ComponentQuery.query("[name=filterFieldName]");c&&c[0]?c[0].setValue(name):console.log("nope")}}},{name:"iterationNoEntryText",xtype:"rallytextfield",fieldLabel:"Text for No Selection Iteration",labelWidth:80,labelAlign:"left",width:250,margin:25},{name:"considerVelocity",xtype:"rallycheckboxfield",boxLabelAlign:"after",fieldLabel:"",margin:"0 0 25 200",boxLabel:'Consider Velocity<br/><span style="color:#999999;"><i>Tick to make display bars a percentage of historical velocity</i></span>'},{name:"groupByFeatureInsteadOfProject",xtype:"rallycheckboxfield",boxLabelAlign:"after",fieldLabel:"",margin:"0 0 25 200",boxLabel:'Group by Feature<br/><span style="color:#999999;"><i>Tick to display bars for each lowest-level PI instead of each project</i></span>'},{name:"showScopeSelector",xtype:"rallycheckboxfield",boxLabelAlign:"after",fieldLabel:"",margin:"0 0 25 200",boxLabel:'Show Scope Selector<br/><span style="color:#999999;"><i>Tick to use this to broadcast settings.</i></span>'}]},_showDetailsDialog:function(a,b,c){var d=Ext.String.format("Stories for {0} ({1})",a,c);Ext.create("Rally.ui.dialog.Dialog",{id:"detail",title:d,width:Ext.getBody().getWidth()-50,height:Ext.getBody().getHeight()-50,closable:!0,layout:"fit",items:[{xtype:"rallygrid",model:"UserStory",showPagingToolbar:!1,showRowActionsColumn:!1,disableSelection:!0,columnCfgs:[{text:"id",dataIndex:"FormattedID"},{text:"Name",dataIndex:"Name",flex:1},{text:"State",dataIndex:"ScheduleState"},{text:"Size",dataIndex:"PlanEstimate"},{text:"Project",dataIndex:"Project",renderer:function(a){return a._refObjectName}}],store:Ext.create("Rally.data.custom.Store",{pageSize:1e5,data:b,sorters:[{property:"ObjectID",direction:"ASC"}],filters:[{property:"ScheduleState",value:c}]})}]}).show()}});
            
               Rally.launchApp('TSProgressByProject', {
                   name: 'Progress by Project'
               });
        });
    </script>
    
    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}


    </style>

</head>
<body></body>
</html>